---
title: "R Notebook: Stringmatch"
output: html_notebook
---


# Load data files
```{r}
# specify the directory where the files are located
dir_path <- "~/enriquemontes01@gmail.com - Google Drive/My Drive/GDrive/OCED_AOML/WS_cruises/plankton_imaging/CPICS/TS.Master/"

# obtain a list of file names in the directory
file_names <- list.files(path = dir_path, pattern = ".txt", full.names = TRUE)

# loop over each file and import the tables
for (file in file_names) {
  table_name <- gsub(".txt", "", basename(file)) # get the name of the table from the file name
  assign(table_name, read.table(file = file, header = FALSE, sep = "\t"))
}

```

# Match file name with string ID
```{r}
library(tidyverse)
library(lubridate)
library(dplyr)

# extract relevant part of the strings
df <- rbind(class.Copepods, 
            class.Eucampia, 
            class.Noctiluca, 
            class.Polychaets,
            class.Acantharea,
            class.Centric,
            class.Ceratium,
            class.Chaetoceros,
            class.Chain2,
            class.Chain3,
            class.Chain4,
            class.Cladocera,
            class.Jellies,
            class.Larvaceans,
            class.pellets)
sub_strings <- substr(df$V1, start = 10, stop = 22)
unique_all <- unique(sub_strings)
  
# select unique dates (this allows to search CTD records per date and time)
# To find unique dates and times to extract CDT data use: unique_all[grepl("20221209", unique_all)]

id_list <- unique_all

conc_occ_count <- data.frame(date = as.Date(character()), stringsAsFactors = FALSE)

for ( i in seq_along(id_list)){
  acantha <- as.data.frame(str_count(class.Acantharea$V1, id_list[i]))
  centric <- as.data.frame(str_count(class.Centric$V1, id_list[i]))
  ceratium <- as.data.frame(str_count(class.Ceratium$V1, id_list[i]))
  chaetoceros <- as.data.frame(str_count(class.Chaetoceros$V1, id_list[i]))
  chaetog <- as.data.frame(str_count(class.Chaetognaths$V1, id_list[i])) 
  chain2 <- as.data.frame(str_count(class.Chain2$V1, id_list[i]))
  chain3 <- as.data.frame(str_count(class.Chain3$V1, id_list[i]))
  chain4 <- as.data.frame(str_count(class.Chain4$V1, id_list[i]))
  clado <- as.data.frame(str_count(class.Cladocera$V1, id_list[i]))
  copepods <- as.data.frame(str_count(class.Copepods$V1, id_list[i]))
  decapod <- as.data.frame(str_count(class.Decapods$V1, id_list[i])) 
  echino <- as.data.frame(str_count(class.Echinoderms$V1, id_list[i]))
  eucampia <- as.data.frame(str_count(class.Eucampia$V1, id_list[i]))
  jellies <- as.data.frame(str_count(class.Jellies$V1, id_list[i]))
  larvae <- as.data.frame(str_count(class.Larvaceans$V1, id_list[i]))
  nocti <- as.data.frame(str_count(class.Noctiluca$V1, id_list[i]))
  polychaetes <- as.data.frame(str_count(class.Polychaets$V1, id_list[i]))
  tricho <- as.data.frame(str_count(class.Tricho$V1, id_list[i]))
  
  occ_acantha <- colSums(acantha != 0)
  occ_centric <- colSums(centric != 0)
  occ_ceratium <- colSums(ceratium != 0)
  occ_chaetoceros <- colSums(chaetoceros != 0)
  occ_chaetog <- colSums(chaetog != 0)
  occ_chain2 <- colSums(chain2 != 0)
  occ_chain3 <- colSums(chain3 != 0)
  occ_chain4 <- colSums(chain4 != 0)
  occ_clado <- colSums(clado != 0)
  occ_copepods <- colSums(copepods != 0)
  occ_decapod <- colSums(decapod != 0)
  occ_echino <- colSums(echino != 0)
  occ_eucampia <- colSums(eucampia != 0)
  occ_jellies<- colSums(jellies != 0)
  occ_larvae <- colSums(larvae != 0)
  occ_nocti <- colSums(nocti != 0)
  occ_polychaetes <- colSums(polychaetes != 0)
  occ_tricho <- colSums(tricho != 0)
  
  # Parse the date-time string with ymd_hm()
  occ_datetime  <- as.POSIXct(id_list[i], format="%Y%m%d_%H%M", tz="UTC")
  occ_datetime_str <- substr(id_list[i], 1, 13)
  
  row_df <- data.frame(date = occ_datetime, occ_datetime_str,
                       occ_acantha,
                       occ_centric,
                       occ_ceratium,
                       occ_chaetoceros,
                       occ_chaetog, 
                       occ_chain2,
                       occ_chain3,
                       occ_chain4,
                       occ_clado,
                       occ_copepods,
                       occ_decapod,
                       occ_echino,
                       occ_eucampia,
                       occ_jellies,
                       occ_larvae,
                       occ_nocti,
                       occ_polychaetes,
                       occ_tricho
                       )
  rownames(row_df) <- i
  
  conc_occ_count <- rbind(conc_occ_count, row_df)
}

conc_occ_final <- arrange(conc_occ_count, date)

```


# Match image records with CTD metadata and seascapes
```{r}
# Directory where the CTD metadata is located
dir_path2 <- "~/enriquemontes01@gmail.com - Google Drive/My Drive/GDrive/OCED_AOML/WS_cruises/plankton_imaging/CPICS/ws_cruise_ctd/"
file_name <- list.files(path = dir_path2, pattern = ".csv", full.names = TRUE)
ctd_meta <- read.csv(file_name, fill = TRUE)

dt_list <- ctd_meta$GMT.datetime

conc_event <- data.frame()

for ( t in seq_along(dt_list)){
  event <- str_count(conc_occ_final$occ_datetime_str, dt_list[t])
  idx_event <- which(event == 1, arr.ind = TRUE)
  occ_row <- conc_occ_final[idx_event, ]
  event_meta <- ctd_meta[idx_event, ]
  conc_event <- rbind(conc_event, occ_row)
}

taxa_meta <- cbind(ctd_meta, conc_event)
```

# Generate plots 
```{r}
library(tidyverse)
library(hrbrthemes)
library(viridis)

# filter out rows with NA values in column seascapes
df_filtered <- taxa_meta[complete.cases(taxa_meta$X8.day.seascapes),]

# Convert the 'x' column to character
df_filtered$X8.day.seascapes <- as.character(df_filtered$X8.day.seascapes)

# Variables
# Avg.chl.a..ug.L.
# salinity
# NH4...uM.
# NO3.NO2..uM.
# DO..mg.L.

# Plot
df_filtered %>%
  ggplot( aes(x=X8.day.seascapes, y=Avg.chl.a..ug.L., fill=X8.day.seascapes)) +
    geom_boxplot() +
    scale_fill_viridis(discrete = TRUE, alpha=0.6) +
    geom_jitter(color="black", size=0.4, alpha=0.9) +
    theme_ipsum() +
    theme(
      legend.position="none",
      plot.title = element_text(size=11)
    ) +
    ggtitle("A boxplot with jitter") +
    xlab("")
```

# Create stackplots showing relative abundance of plankton taxa per seascape category
```{r}
# convert abundance columns to relative abundance

# copepods: col 33
# larvae: col 38
# occ_polychaetes: 40
# occ_jellies: col 37
# acantha: col 24
# eucampia: col 36
# occ_nocti: col 39
# occ_tricho: col 41
# occ_chain2: col 27
# occ_chaetoceros: col 37
# X8.day.seascapes: col 20

df_subset <- df_filtered[ , c(20, 24, 27, 29, 33, 36, 37, 38, 39, 40, 41)] # subsets taxa
# df_subset[, 2:11] <- df_subset[, 2:11] / rowSums(df_subset[, 2:11]) # computes relative abund
# df_subset <-  df_subset[complete.cases(df_subset), ] # remove rows with nan

# reshape the data to long format
df_long <- tidyr::gather(df_subset, key = "Species", value = "Abundance", -X8.day.seascapes)
df_sum <- df_long %>%
  group_by(X8.day.seascapes, Species) %>% 
  summarise(n = sum(Abundance)) %>% 
  mutate(freq = n / sum(n)) 

# create the stackplot
ggplot(df_sum, aes(x = X8.day.seascapes, y = freq, fill = Species)) +
  scale_fill_viridis(option="magma", discrete = TRUE, alpha=0.6) +
  geom_bar(stat = "identity")

```

